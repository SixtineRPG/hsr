<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Kanban Firebase Simple</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 1em;}
    #loginForm, #kanban { margin-top: 2em; }
    #tasks { list-style: none; padding: 0; }
    #tasks li { padding: 0.5em; border: 1px solid #ccc; margin-bottom: 0.5em; display: flex; justify-content: space-between; }
    input[type="text"] { flex-grow: 1; margin-right: 1em; }
    button { cursor: pointer; }
    #addTaskInput { width: 70%; }
  </style>
</head>
<body>

<h1>Kanban privé</h1>

<div id="loginForm">
  <h2>Connexion</h2>
  <input id="email" type="email" placeholder="Email" /><br/><br/>
  <input id="password" type="password" placeholder="Mot de passe" /><br/><br/>
  <button id="loginBtn">Se connecter</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div id="kanban" style="display:none;">
  <button id="logoutBtn">Déconnexion</button>
  <h2>Mes tâches</h2>
  <ul id="tasks"></ul>
  <input id="addTaskInput" placeholder="Nouvelle tâche..." />
  <button id="addTaskBtn">Ajouter</button>
</div>

<!-- Firebase JS SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
  // TODO : remplace par ta config Firebase
  const firebaseConfig = {
  apiKey: "AIzaSyDjMvnPebLgJGUlgJm6_jU19FOfRYYwoK8",
  authDomain: "hsr-tracker-26c18.firebaseapp.com",
  databaseURL: "https://hsr-tracker-26c18-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hsr-tracker-26c18",
  storageBucket: "hsr-tracker-26c18.firebasestorage.app",
  messagingSenderId: "202249444604",
    measurementId: "TA_MEASUREMENTID"
  };

  // Init Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Elements DOM
  const loginForm = document.getElementById('loginForm');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');

  const kanbanDiv = document.getElementById('kanban');
  const logoutBtn = document.getElementById('logoutBtn');
  const tasksUl = document.getElementById('tasks');
  const addTaskInput = document.getElementById('addTaskInput');
  const addTaskBtn = document.getElementById('addTaskBtn');

  let unsubscribeKanban = null;

  // Fonction afficher les tâches dans la liste
  function renderTasks(tasks) {
    tasksUl.innerHTML = '';
    tasks.forEach((task, index) => {
      const li = document.createElement('li');

      const input = document.createElement('input');
      input.type = 'text';
      input.value = task;
      input.onchange = () => {
        tasks[index] = input.value;
        saveTasks(tasks);
      };

      const delBtn = document.createElement('button');
      delBtn.textContent = '❌';
      delBtn.onclick = () => {
        tasks.splice(index, 1);
        saveTasks(tasks);
      };

      li.appendChild(input);
      li.appendChild(delBtn);
      tasksUl.appendChild(li);
    });
  }

  // Sauvegarde dans Firestore
  function saveTasks(tasks) {
    const uid = auth.currentUser.uid;
    db.collection('kanbans').doc(uid).set({ tasks });
  }

  // Ecoute en temps réel des tâches Firestore
  function listenKanban() {
    const uid = auth.currentUser.uid;
    unsubscribeKanban = db.collection('kanbans').doc(uid)
      .onSnapshot(doc => {
        if (doc.exists) {
          const data = doc.data();
          renderTasks(data.tasks || []);
        } else {
          renderTasks([]);
        }
      });
  }

  // Connexion
  loginBtn.onclick = async () => {
    loginError.textContent = '';
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch (err) {
      loginError.textContent = "Erreur login : " + err.message;
    }
  };

  // Déconnexion
  logoutBtn.onclick = () => {
    if(unsubscribeKanban) unsubscribeKanban();
    auth.signOut();
  };

  // Ajout tâche
  addTaskBtn.onclick = () => {
    const newTask = addTaskInput.value.trim();
    if (!newTask) return;
    const uid = auth.currentUser.uid;
    db.collection('kanbans').doc(uid).get().then(doc => {
      let tasks = [];
      if (doc.exists) tasks = doc.data().tasks || [];
      tasks.push(newTask);
      saveTasks(tasks);
      addTaskInput.value = '';
    });
  };

  // Gestion état auth
  auth.onAuthStateChanged(user => {
    if (user) {
      loginForm.style.display = 'none';
      kanbanDiv.style.display = 'block';
      listenKanban();
    } else {
      loginForm.style.display = 'block';
      kanbanDiv.style.display = 'none';
      if(unsubscribeKanban) unsubscribeKanban();
    }
  });
</script>

</body>
</html>
