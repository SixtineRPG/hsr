(async () => {
  const form = document.getElementById("login-form");

  // Si token chiffré existe déjà, cacher le champ token
  if (localStorage.getItem("kanban_token")) {
    document.getElementById("token").closest("label").style.display = "none";
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const pw = form.password.value;
    const tokenField = form.token;
    const tokenStored = localStorage.getItem("kanban_token");

    // Hash mot de passe et vérification (comme avant)
    const pwHash = await sha256(pw);
    if (pwHash !== CORRECT_HASH) {
      alert("Mot de passe incorrect");
      return;
    }

    // Si pas de token stocké, on chiffre et stocke le token
    if (!tokenStored) {
      const token = tokenField.value;
      if (!token) {
        alert("Token requis à la première connexion");
        return;
      }
      const encryptedToken = await encrypt(token, pw);
      localStorage.setItem("kanban_token", encryptedToken);
    }

    localStorage.setItem("kanban_authenticated", "true");
    sessionStorage.setItem("kanban_pw", pw);

    window.location.href = "kanban.html";
  });
})();
